#jinja2: trim_blocks:True, lstrip_blocks:True
# Managed by ansible ({{ ansible_role_name }})
# DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN

{% if nginx_upstream_php_handler_port is defined %}
upstream php-handler {
    server 127.0.0.1:{{ nginx_upstream_php_handler_port }};
}

{% endif %}
{% if nginx_map_asset_immutable is defined %}
# Set the `immutable` cache control options only for assets with a cache busting `v` argument
map $arg_v $asset_immutable {
    "" "";
    default "immutable";
}

{% endif %}
server {
    listen 80;
{% if nginx_ipv6 is defined %}    listen [::]:80;
{% endif %}
    server_name {{ site }}{% if other_ssl_sites is defined %} {{ other_ssl_sites }}{% endif %}{% if other_sites is defined %} {{ other_sites }}{% endif %}{% if site_add_ssl is defined %} {{ site_add_ssl }}{% endif %};
    root /dev/null;
    access_log /srv/www/{{ site }}/logs/access.log{% if nginx_access_log_format is defined %} {{ nginx_access_log_format }}{% endif %};
    error_log  /srv/www/{{ site }}/logs/error.log;

{% if nginx_include_acmesh|default(true) %}    include conf.d/local-mit-acmesh.include;

{% endif %}
    location / {
{% if site_add_ssl is defined %}
        return 301 https://$http_host$request_uri;
{% else %}
        return 301 https://{{ site }}$request_uri;
{% endif %}
    }
}

{% if other_ssl_sites is defined %}
server {
{% if nginx_version is version('1.25', '<') %}
    listen 443 ssl http2;
{% else %}
    listen 443 ssl;
    http2 on;
{% endif %}
{% if nginx_ipv6 is defined %}    listen [::]:443 ssl http2;
{% endif %}
    server_name {{ other_ssl_sites }};
    root /dev/null;
    access_log /srv/www/{{ site }}/logs/access.log{% if nginx_access_log_format is defined %} {{ nginx_access_log_format }}{% endif %};
    error_log  /srv/www/{{ site }}/logs/error.log;
    include conf.d/{{ nginx_ssl_include|default('ssl-'+site+'.include') }};
    return 301 https://{{ site }}$request_uri;
}

{% endif %}
server {
{% if nginx_version is version('1.25', '<') %}
    listen 443 ssl http2;
{% else %}
    listen 443 ssl;
    http2 on;
{% endif %}
{% if nginx_ipv6 is defined %}    listen [::]:443 ssl http2;
{% endif %}
    server_name {{ site }}{% if site_add_ssl is defined %} {{ site_add_ssl }}{% endif %};
{% if nginx_document_root is defined %}
    root {{ nginx_document_root }};
{% else %}
    root /srv/www/{{ site }}/htdocs;
{% endif %}
    access_log /srv/www/{{ site }}/logs/access.log{% if nginx_access_log_format is defined %} {{ nginx_access_log_format }}{% endif %};
    error_log  /srv/www/{{ site }}/logs/error.log;

{% if nginx_client_max_body_size %}
    client_max_body_size {{ nginx_client_max_body_size }};
    client_body_temp_path /srv/www/{{ site }}/tmp/nginx;

{% endif %}
    include conf.d/{{ nginx_ssl_include|default('ssl-'+site+'.include') }};
{% if nginx_include_other|default(false) %}
    {% if nginx_include_other != True %}
    include conf.d/{{ nginx_include_other }};
    {% else %}
    include conf.d/server-{{ site }}.include;
    {% endif %}
{% endif %}
{% if php_fpm_port|default(false) %}

    set $fpm_fastcgi_pass '127.0.0.1:{{ php_fpm_port|default('9999') }}';
{% endif %}
{% if nginx_include_auth_basic|default(false) %}    location / {
        satisfy any;

        allow 10.10.10.180;
        deny  all;

        auth_basic "{{ site }}";
        auth_basic_user_file conf.d/server-{{ site }}.htpasswd;

{% if (nginx_php_include is defined) %}
        # enable execution of php scripts within this location
        include conf.d/{{ nginx_php_include }};
{% endif %}
    }
{% endif %}
{% if nginx_php_include_healthcheck is defined and nginx_php_include_healthcheck != False %}    location /healthcheck {
         satisfy any;

         allow 127.0.0.1;
         allow 192.168.0.0/16;
         allow 10.10.10.180;
         deny  all;

         try_files $uri $uri/ /index.php$is_args$args;
         include conf.d/{{ nginx_php_include_healthcheck|default(nginx_php_include|default('local-mit-php.include')) }};
    }
{% endif %}
{% if (nginx_php_include is defined) %}
    include conf.d/{{ nginx_php_include|default('local-mit-php.include') }};
{% endif %}
}

